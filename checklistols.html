<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта контроля ОЛС: раннее выявление туберкулеза</title>
    <style>
        :root {
            --primary-color: #2c7fb8;
            --secondary-color: #7fcdbb;
            --light-color: #f0f9ff;
            --border-color: #ddd;
            /* убрали переменную --completed-color */
            --save-btn-bg: #ffc107;      /* желтый */
            --save-btn-hover: #e0a800;    /* темно-желтый */
            --export-btn-bg: #28a745;     /* зеленый */
            --export-btn-hover: #218838;   /* темно-зеленый */
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
            font-weight: bold;
        }
        
        .branch-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .branch-info-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .branch-info-row label {
            font-weight: bold;
            min-width: auto;
        }
        
        .branch-info-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            background-color: white;
        }
        
        .timestamp {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        
        .timestamp label {
            font-weight: bold;
        }
        
        .timestamp input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auto-save-status {
            font-size: 0.9rem;
            color: #666;
            margin-left: 0;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section.collapsed {
            max-height: 60px;
        }
        
        .section.expanded {
            max-height: 800px;
        }
        
        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            flex: 1;
        }
        
        .section-content {
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        .section.expanded .section-content {
            display: block;
        }
        
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            background-color: #f9f9f9;
            transition: background-color 0.3s;
            position: relative;
            /* удалено возможное упоминание completed-color */
        }
        
        /* класс completed больше не добавляет зеленый фон */
        .question-text {
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 1rem;
            padding-right: 50px;
            line-height: 1.4;
        }
        
        .check-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        /* зеленая галочка (проверено, замечаний нет) */
        .check-button.checked {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .check-button.checked::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* красная галочка (проверено, есть замечания) */
        .check-button.checked-red {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .check-button.checked-red::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .comment {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            min-height: 60px;
            font-size: 0.95rem;
            overflow: hidden;
            transition: height 0.2s;
        }
        
        .section-status {
            font-size: 0.8rem;
            background-color: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 20px;
        }
        
        button {
            padding: 12px 30px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .save-btn {
            background-color: var(--save-btn-bg);
        }
        
        .save-btn:hover {
            background-color: var(--save-btn-hover);
        }
        
        .export-btn {
            background-color: var(--export-btn-bg);
        }
        
        .export-btn:hover {
            background-color: var(--export-btn-hover);
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }

        .print-btn {
            background-color: #9c27b0;
        }
        
        .print-btn:hover {
            background-color: #7b1fa2;
        }

        /* Стили для печати */
        @media print {
            body {
                background-color: white;
                padding: 5mm !important;
                margin: 0 !important;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0 !important;
                max-width: none !important;
                margin: 0 !important;
                width: 100% !important;
            }
            
            .controls, .progress-bar, .auto-save-status {
                display: none !important;
            }
            
            .branch-info input {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                font-weight: normal !important;
            }
            
            .section {
                max-height: none !important;
                margin-bottom: 10px !important;
                border: 1px solid #000 !important;
            }
            
            .section.collapsed {
                max-height: none !important;
            }
            
            .section-content {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 8px !important;
            }
            
            .section-header {
                cursor: default;
                background-color: #2c7fb8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 6px 8px !important;
                margin-bottom: 0 !important;
            }
            
            .section-header h2 {
                font-size: 11pt !important;
                margin: 0 !important;
            }
            
            .sections-grid {
                display: block !important;
                grid-template-columns: none !important;
                gap: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .question {
                margin-bottom: 8px !important;
                padding: 6px !important;
                background-color: #f9f9f9 !important; /* убираем возможные изменения фона */
            }
            
            .question-text {
                font-size: 9pt !important;
                margin-bottom: 5px !important;
                padding-right: 35px !important;
            }
            
            .check-button {
                width: 20px !important;
                height: 20px !important;
                top: 6px !important;
                right: 6px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .check-button.checked::after,
            .check-button.checked-red::after {
                font-size: 10px !important;
            }
            
            .comment {
                min-height: 40px !important;
                padding: 4px !important;
                font-size: 9pt !important;
                border: 1px solid #000 !important;
            }
            
            .section-status {
                display: none !important;
            }
            
            header {
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }
            
            h1 {
                font-size: 14pt !important;
                margin-bottom: 5px !important;
            }
            
            .timestamp {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .timestamp input {
                padding: 4px !important;
                font-size: 10pt !important;
                border: none !important;
                background: transparent !important;
            }
        }
        
        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header h2 {
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Карта контроля организации раннего выявления туберкулеза в учреждениях общей лечебной сети</h1>
        </header>
        
        <div class="branch-info">
            <div class="branch-info-row">
                <label for="org-name">Медицинская организация:</label>
                <input type="text" id="org-name" name="org-name" placeholder="Введите название">
            </div>
            <div class="branch-info-row">
                <label for="org-department">Подразделение / Участок:</label>
                <input type="text" id="org-department" name="org-department" placeholder="Введите подразделение">
            </div>
        </div>
        
        <div class="timestamp">
            <label for="timestamp">Дата проверки:</label>
            <input type="date" id="timestamp" name="timestamp">
            <div class="auto-save-status" id="auto-save-status">Автосохранение включено</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="sections-grid" id="sections-container">
            <!-- Секции будут сгенерированы автоматически -->
        </div>
        
        <div class="controls">
            <button id="save-btn" class="save-btn">Сохранить данные</button>
            <button id="export-btn" class="export-btn">Скачать Excel файл</button>
            <button id="clear-btn" class="clear-btn">Очистить форму</button>
            <button id="print-btn" class="print-btn">Печать формы</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Данные чек-листа из таблицы "Новая таблица (4).xlsx"
        const sections = [
            {
                title: "1. Противотуберкулезное отделение, больницы",
                questions: [
                    "Наличие паспортов участков у врача-фтизиатра (зонное обслуживание терапевтов)",
                    "Наличие плана курации поликлиник, амбулаторий",
                    "Копии актов выхода врача-фтизиатра в ЛПУ и их кратность, соответствие плану курации",
                    "Наличие регламентирующей документации о раннем выявлении туберкулеза",
                    "Организация работы о передаче информации в поликлинику (списки): - впервые выявленные; - снятые с ПТУ; - умершие от туберкулеза",
                    "Наличие в отделении «Журнала передачи информации» о детях из контакта заболевшего взрослого",
                    "Организация работы фтизиатра с ОЛС по обследованию контактных по подъезду"
                ],
                hasComment: true
            },
            {
                title: "2.1. ОЛС - Поликлиника. Руководитель подразделения",
                questions: [
                    "Наличие и содержание Приказа о назначении лиц, ответственных за организацию выполнения мероприятий по раннему выявлению туберкулеза среди населения (взрослого и детей), прикрепленного к поликлиническому отделению за: - составление и выполнение плана профилактических осмотров; - проведения ФЛГ исследований; - исследования мокроты на КУМ; - проведения иммунологических проб",
                    "Наличие в поликлинике (поликлиническом отделении) регламентирующей документации по раннему выявлению туберкулеза",
                    "Наличие актов с результатами кураторского выхода участкового врача-фтизиатра в медицинскую организацию, справок об устранении, реализации замечаний и предложений",
                    "Наличие плана исправлений по результатам выезда фтизиатров и результаты",
                    "Наличие плана проведения профилактического осмотра поликлиники (поликлинического отделения) прикрепленного населения на туберкулез на текущий год",
                    "Наличие заполненного свода мониторинга и профилактических осмотров взрослого населения (приложение 1 к приказу 445-р)",
                    "Укомплектованность участковыми врачами терапевтами",
                    "Укомплектованность врачами общеврачебной практики",
                    "Количество проведенных разборов случаев позднего выявления туберкулеза"
                ],
                hasComment: true
            },
            {
                title: "2.2. ОЛС - Поликлиника. Терапевтический участок",
                questions: [
                    "Наличие плана профилактического осмотра на участке (Паспорт участка)",
                    "Списочный состав групп риска. Инструмент контроля кратности рентген исследований и иммунодиагностики, назначение мокроты на КУМ",
                    "Список нетранспортабельных. Кратность назначения анализа мокроты на КУМ (охват)",
                    "Алгоритм контроля и привлечения населения, не проходившего графические обследования два года и более",
                    "Кратность назначения Диаскинтеста группам риска (охват)",
                    "Проверка знаний персоналом правил сбора мокроты и наличие памяток для пациентов"
                ],
                hasComment: true
            },
            {
                title: "2.3. ОЛС - Поликлиника. Узкие специалисты",
                questions: [
                    "Организация работы по направлению на иммунодиагностические исследования эндокринологом",
                    "Организация работы по направлению на иммунодиагностические исследования инфекционистом"
                ],
                hasComment: true
            },
            {
                title: "2.4. ОЛС - Поликлиника. Процедурный кабинет",
                questions: [
                    "Наличие подготовленного персонала для Диаскинтеста",
                    "Наличие кабинета для Диаскинтеста",
                    "Расписание работы кабинета для постановки Диаскинтеста",
                    "График работы для диаскин-теста",
                    "Введение журналов. Количество групп риска, наличие отметок о результатах",
                    "Организация обратной связи и алгоритм дообследования пациентов с положительным результатом",
                    "Соблюдение сроков направления пациентов с сомнительной/положительной реакцией на Диаскинтест к врачу-фтизиатру (не более 6 календарных дней)"
                ],
                hasComment: true
            },
            {
                title: "3.0. ФЛГ-кабинет",
                questions: [
                    "График работы, количество смен",
                    "Нагрузка на аппарат",
                    "Контрольно-технический журнал флюорографического аппарата (соблюдение графика технического обслуживания)",
                    "Укомплектованность врачами рентгенологами",
                    "Укомплектованность рентгенлаборантами",
                    "Укомплектованность медрегистраторами",
                    "Оснащенность оборудованием (год выпуска и срок эксплуатации, ремонт, работоспособность, амортизация)",
                    "Журнал ежедневного учета обследуемых («Журнал потока»)",
                    "Количество проведенных исследований",
                    "Наличие дублированного чтения (в том числе с использованием ИИ)",
                    "Наличие журнала регистрации выявленной патологии при ФЛГ обследовании («Журнал патологии»)",
                    "Наличие даты подтверждения (или снятия) диагноза (туберкулез) в «Журнале патологии»",
                    "Дата передачи информации о выявленной патологии, подозрении на туберкулез в ПТД, как информация передается фтизиатрам при подозрении на туберкулез",
                    "Соблюдение сроков передачи информации о пациенте с подозрением на туберкулез в ПТД (не более 2 календарных дней)",
                    "Количество диагностируемых случаев туберкулеза в течение текущего года"
                ],
                hasComment: true
            },
            {
                title: "4. КДЛ (Клинико-диагностическая лаборатория)",
                questions: [
                    "Наличие учетной документации по выявлению туберкулеза методом микроскопии согласно Приказа № 690",
                    "Наличие Журнала регистрации диагностического материала, собранного для микроскопических исследований на туберкулез (учетная форма № 04-1-ТБ/у)",
                    "Наличие в журнале отметок о лице, направившем пациента. Необходимо для анализа организации работы в амбулаторных подразделениях",
                    "Оформление сопроводительного листа доставки диагностического материала для микроскопического исследования на туберкулез (учетная форма № 04-2-ТБ/у)",
                    "Наличие лицензии о деятельности лаборатории в области использования возбудителей инфекционных заболеваний человека и животных и генно-инженерно-модифицированных организмов III и IV степеней потенциальной опасности, организация рабочего места в лаборатории для микроскопического исследования мокроты на КУМ (простая бактериоскопия, люминесцентная микроскопия)",
                    "Наличие подготовленного персонала для исследования мокроты на КУМ",
                    "Наличие ответственного лица для работы в кабинете забора мокроты",
                    "Определение алгоритма (регламента либо стандартной операционной процедуры) по организации и выполнению забора мокроты на исследование для обследуемых, в том числе для маломобильных и нетранспортабельных граждан",
                    "Соблюдение кратности исследования (3 раза), 1 раз в год",
                    "Количество исследований мокроты в течение текущего года (КУМ)",
                    "Количество положительных результатов",
                    "Алгоритм действий при выявлении положительного результата",
                    "Соблюдение сроков хранения «стекол» с положительным мазком на КУМ"
                ],
                hasComment: true
            }
        ];

                // Глобальные переменные
        let answers = {};
        let autoSaveInterval;
        let lastSaveTime = null;
        let autoSaveTimer = null;
        let currentExpandedSection = null;
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Установка текущей даты
            const now = new Date();
            const timestampInput = document.getElementById('timestamp');
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            timestampInput.value = `${year}-${month}-${day}`;
            
            // Генерация скелета секций (только заголовки)
            generateSectionSkeletons();
            
            // Загрузка сохраненных данных
            loadFromLocalStorage();
            
            // Обновление прогресс-бара
            updateProgressBar();
            
            // Обработчики событий для кнопок
            document.getElementById('save-btn').addEventListener('click', () => saveToLocalStorage(false));
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('print-btn').addEventListener('click', printForm);
            
            // Периодическое автосохранение (раз в 3 минуты)
            setInterval(() => saveToLocalStorage(true), 3 * 60 * 1000);
            
            // Автосохранение при закрытии страницы
            window.addEventListener('beforeunload', () => {
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                }
                saveToLocalStorage(true);
            });
            
            updateAutoSaveStatus();
        });
        
        // Функция печати
        function printForm() {
            // Раскрываем все секции перед печатью
            document.querySelectorAll('.section').forEach(section => {
                if (!section.dataset.initialized) {
                    const sectionIndex = section.dataset.sectionIndex;
                    lazyLoadSectionContent(section, parseInt(sectionIndex));
                    section.dataset.initialized = 'true';
                }
                section.classList.remove('collapsed');
                section.classList.add('expanded');
            });
            
            setTimeout(() => window.print(), 100);
        }
        
        // Настройка автосайза для textarea в секции
        function setupAutoResizeForSection(container) {
            container.querySelectorAll('.comment').forEach(textarea => {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            });
        }
        
        // Генерация скелета секций (только заголовки)
        function generateSectionSkeletons() {
            const container = document.getElementById('sections-container');
            
            sections.forEach((section, index) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section collapsed';
                sectionElement.dataset.sectionIndex = index;
                
                const header = document.createElement('div');
                header.className = 'section-header';
                header.dataset.sectionIndex = index;
                
                const title = document.createElement('h2');
                title.textContent = section.title;
                
                const status = document.createElement('div');
                status.className = 'section-status';
                status.textContent = `0/${section.questions.length + 1}`;
                
                header.appendChild(title);
                header.appendChild(status);
                
                const content = document.createElement('div');
                content.className = 'section-content';
                
                sectionElement.appendChild(header);
                sectionElement.appendChild(content);
                container.appendChild(sectionElement);
                
                // Обработчик клика с ленивой загрузкой
                header.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const section = this.closest('.section');
                    const sectionIndex = section.dataset.sectionIndex;
                    
                    if (!section.dataset.initialized) {
                        lazyLoadSectionContent(section, parseInt(sectionIndex));
                        section.dataset.initialized = 'true';
                    }
                    
                    toggleSection(section);
                });
            });
        }
        
        // Управление сворачиванием/разворачиванием секции
        function toggleSection(section) {
            const wasCollapsed = section.classList.contains('collapsed');
            
            if (currentExpandedSection && currentExpandedSection !== section) {
                currentExpandedSection.classList.remove('expanded');
                currentExpandedSection.classList.add('collapsed');
            }
            
            if (wasCollapsed) {
                section.classList.remove('collapsed');
                section.classList.add('expanded');
                currentExpandedSection = section;
                
                setTimeout(() => {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            } else {
                section.classList.remove('expanded');
                section.classList.add('collapsed');
                if (currentExpandedSection === section) {
                    currentExpandedSection = null;
                }
            }
        }
        
        // Ленивая загрузка контента секции
        function lazyLoadSectionContent(sectionElement, sectionIndex) {
            const contentElement = sectionElement.querySelector('.section-content');
            const sectionData = sections[sectionIndex];
            
            sectionData.questions.forEach((question, qIndex) => {
                contentElement.appendChild(createQuestionElement(sectionIndex, qIndex, question));
            });
            
            contentElement.appendChild(createQuestionElement(
                sectionIndex, 
                sectionData.questions.length, 
                "Дополнительная информация / Примечания"
            ));
            
            restoreSectionFromAnswers(sectionIndex, contentElement);
            setupAutoResizeForSection(contentElement);
        }
        
        // Восстановление секции из сохраненных ответов
        function restoreSectionFromAnswers(sectionIndex, container) {
            if (!answers[sectionIndex]) return;
            
            Object.entries(answers[sectionIndex]).forEach(([qIndex, data]) => {
                const questionElement = container.querySelector(`[data-question-id="${sectionIndex}-${qIndex}"]`);
                if (!questionElement) return;
                
                const checkButton = questionElement.querySelector('.check-button');
                const commentArea = questionElement.querySelector('.comment');
                
                if (data.answer === 'Проверено') {
                    checkButton.classList.add('checked');
                } else if (data.answer === 'Проверено (замечания)') {
                    checkButton.classList.add('checked-red');
                }
                
                if (data.comment) {
                    commentArea.value = data.comment;
                    commentArea.style.height = 'auto';
                    commentArea.style.height = (commentArea.scrollHeight) + 'px';
                }
            });
            
            updateSectionStatus(sectionIndex);
        }
        
        // Создание элемента вопроса
        function createQuestionElement(sectionIndex, questionIndex, questionText) {
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            questionElement.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            
            const questionTextElement = document.createElement('div');
            questionTextElement.className = 'question-text';
            questionTextElement.textContent = questionText;
            
            const checkButton = document.createElement('div');
            checkButton.className = 'check-button';
            checkButton.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            
            questionElement.appendChild(questionTextElement);
            questionElement.appendChild(checkButton);
            
            const comment = document.createElement('textarea');
            comment.className = 'comment';
            comment.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            comment.placeholder = 'Комментарий / замечания...';
            
            questionElement.appendChild(comment);
            
            // Состояние для отслеживания изменений
            let previousState = {
                isChecked: false,
                hasComment: false
            };
            
            // Функция обновления счетчика
            const updateState = (newChecked, newHasComment) => {
                if (previousState.isChecked !== newChecked) {
                    updateProgressBar();
                }
                previousState = { isChecked: newChecked, hasComment: newHasComment };
            };
            
            // Обработчик клика по галочке
            checkButton.addEventListener('click', function(e) {
                e.stopPropagation();
                
                if (this.classList.contains('checked')) {
                    this.classList.remove('checked');
                } else if (this.classList.contains('checked-red')) {
                    this.classList.remove('checked-red');
                } else {
                    if (comment.value.trim() !== '') {
                        this.classList.add('checked-red');
                    } else {
                        this.classList.add('checked');
                    }
                }
                
                const isChecked = this.classList.contains('checked') || this.classList.contains('checked-red');
                const answerStatus = isChecked ? 
                    (this.classList.contains('checked-red') ? 'Проверено (замечания)' : 'Проверено') : 
                    'Не проверено';
                
                saveAnswer(sectionIndex, questionIndex, answerStatus, comment.value);
                updateSectionStatus(sectionIndex);
                updateState(isChecked, comment.value.trim() !== '');
                scheduleAutoSave();
            });
            
            // Обработчик ввода в комментарий
            comment.addEventListener('input', function() {
                const hasCommentText = this.value.trim() !== '';
                const wasChecked = checkButton.classList.contains('checked') || checkButton.classList.contains('checked-red');
                
                if (hasCommentText) {
                    if (!checkButton.classList.contains('checked-red') && !checkButton.classList.contains('checked')) {
                        checkButton.classList.add('checked-red');
                    }
                } else {
                    if (checkButton.classList.contains('checked-red') && !checkButton.classList.contains('checked')) {
                        checkButton.classList.remove('checked-red');
                    }
                }
                
                const isNowChecked = checkButton.classList.contains('checked') || checkButton.classList.contains('checked-red');
                const answerStatus = isNowChecked ? 
                    (checkButton.classList.contains('checked-red') ? 'Проверено (замечания)' : 'Проверено') : 
                    'Не проверено';
                
                saveAnswer(sectionIndex, questionIndex, answerStatus, this.value);
                
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                
                scheduleAutoSave();
            });
            
            return questionElement;
        }
        
        // Сохранение ответа
        function saveAnswer(sectionIndex, questionIndex, answer, comment = null) {
            if (!answers[sectionIndex]) answers[sectionIndex] = {};
            if (!answers[sectionIndex][questionIndex]) answers[sectionIndex][questionIndex] = {};
            answers[sectionIndex][questionIndex].answer = answer;
            answers[sectionIndex][questionIndex].comment = comment;
        }
        
        // Обновление статуса секции
        function updateSectionStatus(sectionIndex) {
            const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
            const statusElement = section.querySelector('.section-status');
            const totalQuestions = sections[sectionIndex].questions.length + 1;
            const answeredQuestions = section.querySelectorAll('.check-button.checked, .check-button.checked-red').length;
            statusElement.textContent = `${answeredQuestions}/${totalQuestions}`;
        }
        
        // Обновление прогресс-бара
        function updateProgressBar() {
            const progressBar = document.getElementById('progress');
            let totalQuestions = 0;
            let answeredQuestions = 0;
            
            sections.forEach((section, index) => {
                totalQuestions += section.questions.length + 1;
                const sectionElement = document.querySelector(`.section[data-section-index="${index}"]`);
                if (sectionElement && sectionElement.dataset.initialized) {
                    answeredQuestions += sectionElement.querySelectorAll('.check-button.checked, .check-button.checked-red').length;
                } else if (answers[index]) {
                    answeredQuestions += Object.keys(answers[index]).length;
                }
            });
            
            const progressPercentage = (answeredQuestions / totalQuestions) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        // Планирование автосохранения
        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(() => saveToLocalStorage(true), 2000);
        }
        
        // Сохранение в localStorage
        function saveToLocalStorage(silent = false) {
            document.querySelectorAll('.section[data-initialized="true"]').forEach(section => {
                const sectionIndex = section.dataset.sectionIndex;
                section.querySelectorAll('.question').forEach(question => {
                    const questionId = question.dataset.questionId.split('-');
                    const qIndex = parseInt(questionId[1]);
                    const checkButton = question.querySelector('.check-button');
                    const comment = question.querySelector('.comment').value;
                    
                    let answerStatus = 'Не проверено';
                    if (checkButton.classList.contains('checked')) answerStatus = 'Проверено';
                    else if (checkButton.classList.contains('checked-red')) answerStatus = 'Проверено (замечания)';
                    
                    saveAnswer(parseInt(sectionIndex), qIndex, answerStatus, comment);
                });
            });
            
            const timestamp = document.getElementById('timestamp').value;
            const orgName = document.getElementById('org-name').value;
            const orgDepartment = document.getElementById('org-department').value;
            
            const data = {
                timestamp: timestamp,
                orgName: orgName,
                orgDepartment: orgDepartment,
                answers: answers,
                lastSaved: new Date().toLocaleString('ru-RU')
            };
            
            localStorage.setItem('tb_early_detection_checklist_v4', JSON.stringify(data));
            lastSaveTime = new Date();
            
            if (!silent) alert('Данные сохранены в браузере!');
            updateAutoSaveStatus();
            autoSaveTimer = null;
        }
        
        // Обновление статуса автосохранения
        function updateAutoSaveStatus() {
            const statusElement = document.getElementById('auto-save-status');
            if (lastSaveTime) {
                const timeString = lastSaveTime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                statusElement.textContent = `Автосохранение: ${timeString}`;
            } else {
                statusElement.textContent = 'Автосохранение включено';
            }
        }
        
        // Загрузка из localStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('tb_early_detection_checklist_v4');
            if (savedData) {
                const data = JSON.parse(savedData);
                answers = data.answers || {};
                
                if (data.timestamp) document.getElementById('timestamp').value = data.timestamp;
                if (data.orgName) document.getElementById('org-name').value = data.orgName;
                if (data.orgDepartment) document.getElementById('org-department').value = data.orgDepartment;
                
                updateProgressBar();
                updateAutoSaveStatus();
            }
        }
        
        // Очистка формы
        function clearForm() {
            if (confirm('Вы уверены, что хотите очистить всю форму? Все данные будут удалены.')) {
                answers = {};
                localStorage.removeItem('tb_early_detection_checklist_v4');
                
                document.querySelectorAll('.section[data-initialized="true"]').forEach(section => {
                    const content = section.querySelector('.section-content');
                    content.innerHTML = '';
                    delete section.dataset.initialized;
                    
                    const sectionIndex = section.dataset.sectionIndex;
                    const statusElement = section.querySelector('.section-status');
                    statusElement.textContent = `0/${sections[sectionIndex].questions.length + 1}`;
                });
                
                document.getElementById('org-name').value = '';
                document.getElementById('org-department').value = '';
                
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                document.getElementById('timestamp').value = `${year}-${month}-${day}`;
                
                updateProgressBar();
                updateAutoSaveStatus();
                alert('Форма очищена!');
            }
        }
        
        // Экспорт в Excel
        function exportToExcel() {
            const timestamp = document.getElementById('timestamp').value;
            const date = new Date(timestamp + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('ru-RU');
            const orgName = document.getElementById('org-name').value || 'Не указано';
            const orgDepartment = document.getElementById('org-department').value || 'Не указано';
            
            // Сохраняем все данные перед экспортом
            document.querySelectorAll('.section[data-initialized="true"]').forEach(section => {
                const sectionIndex = section.dataset.sectionIndex;
                section.querySelectorAll('.question').forEach(question => {
                    const questionId = question.dataset.questionId.split('-');
                    const qIndex = parseInt(questionId[1]);
                    const checkButton = question.querySelector('.check-button');
                    const comment = question.querySelector('.comment').value;
                    
                    let answerStatus = 'Не проверено';
                    if (checkButton.classList.contains('checked')) answerStatus = 'Проверено';
                    else if (checkButton.classList.contains('checked-red')) answerStatus = 'Проверено (замечания)';
                    
                    saveAnswer(parseInt(sectionIndex), qIndex, answerStatus, comment);
                });
            });
            
            const wb = XLSX.utils.book_new();
            const excelData = [];
            
            excelData.push(["Карта контроля организации раннего выявления туберкулеза в учреждениях общей лечебной сети"]);
            excelData.push([`Медицинская организация: ${orgName}`]);
            excelData.push([`Подразделение / Участок: ${orgDepartment}`]);
            excelData.push([`Дата проверки: ${formattedDate}`]);
            excelData.push([]);
            excelData.push(["Раздел", "Вопрос", "Статус", "Комментарий"]);
            
            sections.forEach((section, sectionIndex) => {
                excelData.push([section.title, "", "", ""]);
                
                section.questions.forEach((question, questionIndex) => {
                    const answerData = answers[sectionIndex]?.[questionIndex];
                    const answer = answerData?.answer || 'Не проверено';
                    const comment = answerData?.comment || '';
                    excelData.push(["", question, answer, comment]);
                });
                
                const additionalInfoData = answers[sectionIndex]?.[section.questions.length];
                const additionalInfoAnswer = additionalInfoData?.answer || 'Не проверено';
                const additionalInfoComment = additionalInfoData?.comment || '';
                excelData.push(["", "Дополнительная информация / Примечания", additionalInfoAnswer, additionalInfoComment]);
                excelData.push([]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            ws['!cols'] = [
                { wch: 20 },
                { wch: 50 },
                { wch: 15 },
                { wch: 50 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, "Чек-лист ОЛС");
            XLSX.writeFile(wb, `карта_контроля_ОЛС_${formattedDate.replace(/\./g, '-')}.xlsx`);
        }
</script>
</body>
</html>
