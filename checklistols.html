<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта контроля ОЛС: раннее выявление туберкулеза</title>
    <style>
        :root {
            --primary-color: #2c7fb8;
            --secondary-color: #7fcdbb;
            --light-color: #f0f9ff;
            --border-color: #ddd;
            --completed-color: #e6f7e6;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
            font-weight: bold;
        }
        
        .branch-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .branch-info-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .branch-info-row label {
            font-weight: bold;
            min-width: 150px;
        }
        
        .branch-info-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            background-color: white;
        }
        
        .timestamp {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .timestamp label {
            font-weight: bold;
        }
        
        .timestamp input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auto-save-status {
            margin-left: auto;
            font-size: 0.9rem;
            color: #666;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section.collapsed {
            max-height: 60px;
        }
        
        .section.expanded {
            max-height: 800px;
        }
        
        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            flex: 1;
        }
        
        .section-content {
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        .section.expanded .section-content {
            display: block;
        }
        
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            background-color: #f9f9f9;
            transition: background-color 0.3s;
            position: relative;
        }
        
        .question.completed {
            background-color: var(--completed-color);
        }
        
        .question-text {
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 1rem;
            padding-right: 50px;
            line-height: 1.4;
        }
        
        .check-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .check-button.checked {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .check-button.checked::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .comment {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            min-height: 60px;
            font-size: 0.95rem;
            overflow: hidden;
            transition: height 0.2s;
        }
        
        .section-status {
            font-size: 0.8rem;
            background-color: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 20px;
        }
        
        button {
            padding: 12px 30px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #1a5a8a;
        }
        
        .save-btn {
            background-color: #4CAF50;
        }
        
        .save-btn:hover {
            background-color: #3d8b40;
        }
        
        .export-btn {
            background-color: #ff9800;
        }
        
        .export-btn:hover {
            background-color: #e68900;
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }

        .print-btn {
            background-color: #9c27b0;
        }
        
        .print-btn:hover {
            background-color: #7b1fa2;
        }

        /* Стили для печати */
        @media print {
            body {
                background-color: white;
                padding: 5mm !important;
                margin: 0 !important;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0 !important;
                max-width: none !important;
                margin: 0 !important;
                width: 100% !important;
            }
            
            .controls, .progress-bar, .auto-save-status {
                display: none !important;
            }
            
            .branch-info input {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                font-weight: normal !important;
            }
            
            .section {
                max-height: none !important;
                margin-bottom: 10px !important;
                border: 1px solid #000 !important;
            }
            
            .section.collapsed {
                max-height: none !important;
            }
            
            .section-content {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 8px !important;
            }
            
            .section-header {
                cursor: default;
                background-color: #2c7fb8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 6px 8px !important;
                margin-bottom: 0 !important;
            }
            
            .section-header h2 {
                font-size: 11pt !important;
                margin: 0 !important;
            }
            
            .sections-grid {
                display: block !important;
                grid-template-columns: none !important;
                gap: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .question {
                margin-bottom: 8px !important;
                padding: 6px !important;
            }
            
            .question-text {
                font-size: 9pt !important;
                margin-bottom: 5px !important;
                padding-right: 35px !important;
            }
            
            .check-button {
                width: 20px !important;
                height: 20px !important;
                top: 6px !important;
                right: 6px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .check-button.checked::after {
                font-size: 10px !important;
            }
            
            .comment {
                min-height: 40px !important;
                padding: 4px !important;
                font-size: 9pt !important;
                border: 1px solid #000 !important;
            }
            
            .section-status {
                display: none !important;
            }
            
            header {
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }
            
            h1 {
                font-size: 14pt !important;
                margin-bottom: 5px !important;
            }
            
            .timestamp {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .timestamp input {
                padding: 4px !important;
                font-size: 10pt !important;
                border: none !important;
                background: transparent !important;
            }
        }
        
        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header h2 {
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Карта контроля организации раннего выявления туберкулеза в учреждениях общей лечебной сети</h1>
        </header>
        
        <div class="branch-info">
            <div class="branch-info-row">
                <label for="org-name">Медицинская организация:</label>
                <input type="text" id="org-name" name="org-name" placeholder="Введите название">
            </div>
            <div class="branch-info-row">
                <label for="org-department">Подразделение / Участок:</label>
                <input type="text" id="org-department" name="org-department" placeholder="Введите подразделение">
            </div>
        </div>
        
        <div class="timestamp">
            <label for="timestamp">Дата проверки:</label>
            <input type="date" id="timestamp" name="timestamp">
            <div class="auto-save-status" id="auto-save-status">Автосохранение включено</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="sections-grid" id="sections-container">
            <!-- Секции будут сгенерированы автоматически -->
        </div>
        
        <div class="controls">
            <button id="save-btn" class="save-btn">Сохранить данные</button>
            <button id="export-btn" class="export-btn">Скачать Excel файл</button>
            <button id="clear-btn" class="clear-btn">Очистить форму</button>
            <button id="print-btn" class="print-btn">Печать формы</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Данные чек-листа из таблицы "Новая таблица (4).xlsx"
        const sections = [
            {
                title: "1. Противотуберкулезное отделение, больницы",
                questions: [
                    "Наличие паспортов участков у врача-фтизиатра (зонное обслуживание терапевтов)",
                    "Наличие плана курации поликлиник, амбулаторий",
                    "Копии актов выхода врача-фтизиатра в ЛПУ и их кратность, соответствие плану курации",
                    "Наличие регламентирующей документации о раннем выявлении туберкулеза",
                    "Организация работы о передаче информации в поликлинику (списки): - впервые выявленные; - снятые с ПТУ; - умершие от туберкулеза",
                    "Наличие в отделении «Журнала передачи информации» о детях из контакта заболевшего взрослого",
                    "Организация работы фтизиатра с ОЛС по обследованию контактных по подъезду"
                ],
                hasComment: true
            },
            {
                title: "2.1. ОЛС - Поликлиника. Руководитель подразделения",
                questions: [
                    "Наличие и содержание Приказа о назначении лиц, ответственных за организацию выполнения мероприятий по раннему выявлению туберкулеза среди населения (взрослого и детей), прикрепленного к поликлиническому отделению за: - составление и выполнение плана профилактических осмотров; - проведения ФЛГ исследований; - исследования мокроты на КУМ; - проведения иммунологических проб",
                    "Наличие в поликлинике (поликлиническом отделении) регламентирующей документации по раннему выявлению туберкулеза",
                    "Наличие актов с результатами кураторского выхода участкового врача-фтизиатра в медицинскую организацию, справок об устранении, реализации замечаний и предложений",
                    "Наличие плана исправлений по результатам выезда фтизиатров и результаты",
                    "Наличие плана проведения профилактического осмотра поликлиники (поликлинического отделения) прикрепленного населения на туберкулез на текущий год",
                    "Наличие заполненного свода мониторинга и профилактических осмотров взрослого населения (приложение 1 к приказу 445-р)",
                    "Укомплектованность участковыми врачами терапевтами",
                    "Укомплектованность врачами общеврачебной практики",
                    "Количество проведенных разборов случаев позднего выявления туберкулеза"
                ],
                hasComment: true
            },
            {
                title: "2.2. ОЛС - Поликлиника. Терапевтический участок",
                questions: [
                    "Наличие плана профилактического осмотра на участке (Паспорт участка)",
                    "Списочный состав групп риска. Инструмент контроля кратности рентген исследований и иммунодиагностики, назначение мокроты на КУМ",
                    "Список нетранспортабельных. Кратность назначения анализа мокроты на КУМ (охват)",
                    "Алгоритм контроля и привлечения населения, не проходившего графические обследования два года и более",
                    "Кратность назначения Диаскинтеста группам риска (охват)",
                    "Проверка знаний персоналом правил сбора мокроты и наличие памяток для пациентов"
                ],
                hasComment: true
            },
            {
                title: "2.3. ОЛС - Поликлиника. Узкие специалисты",
                questions: [
                    "Организация работы по направлению на иммунодиагностические исследования эндокринологом",
                    "Организация работы по направлению на иммунодиагностические исследования инфекционистом"
                ],
                hasComment: true
            },
            {
                title: "2.4. ОЛС - Поликлиника. Процедурный кабинет",
                questions: [
                    "Наличие подготовленного персонала для Диаскинтеста",
                    "Наличие кабинета для Диаскинтеста",
                    "Расписание работы кабинета для постановки Диаскинтеста",
                    "График работы для диаскин-теста",
                    "Введение журналов. Количество групп риска, наличие отметок о результатах",
                    "Организация обратной связи и алгоритм дообследования пациентов с положительным результатом",
                    "Соблюдение сроков направления пациентов с сомнительной/положительной реакцией на Диаскинтест к врачу-фтизиатру (не более 6 календарных дней)"
                ],
                hasComment: true
            },
            {
                title: "3.0. ФЛГ-кабинет",
                questions: [
                    "График работы, количество смен",
                    "Нагрузка на аппарат",
                    "Контрольно-технический журнал флюорографического аппарата (соблюдение графика технического обслуживания)",
                    "Укомплектованность врачами рентгенологами",
                    "Укомплектованность рентгенлаборантами",
                    "Укомплектованность медрегистраторами",
                    "Оснащенность оборудованием (год выпуска и срок эксплуатации, ремонт, работоспособность, амортизация)",
                    "Журнал ежедневного учета обследуемых («Журнал потока»)",
                    "Количество проведенных исследований",
                    "Наличие дублированного чтения (в том числе с использованием ИИ)",
                    "Наличие журнала регистрации выявленной патологии при ФЛГ обследовании («Журнал патологии»)",
                    "Наличие даты подтверждения (или снятия) диагноза (туберкулез) в «Журнале патологии»",
                    "Дата передачи информации о выявленной патологии, подозрении на туберкулез в ПТД, как информация передается фтизиатрам при подозрении на туберкулез",
                    "Соблюдение сроков передачи информации о пациенте с подозрением на туберкулез в ПТД (не более 2 календарных дней)",
                    "Количество диагностируемых случаев туберкулеза в течение текущего года"
                ],
                hasComment: true
            },
            {
                title: "4. КДЛ (Клинико-диагностическая лаборатория)",
                questions: [
                    "Наличие учетной документации по выявлению туберкулеза методом микроскопии согласно Приказа № 690",
                    "Наличие Журнала регистрации диагностического материала, собранного для микроскопических исследований на туберкулез (учетная форма № 04-1-ТБ/у)",
                    "Наличие в журнале отметок о лице, направившем пациента. Необходимо для анализа организации работы в амбулаторных подразделениях",
                    "Оформление сопроводительного листа доставки диагностического материала для микроскопического исследования на туберкулез (учетная форма № 04-2-ТБ/у)",
                    "Наличие лицензии о деятельности лаборатории в области использования возбудителей инфекционных заболеваний человека и животных и генно-инженерно-модифицированных организмов III и IV степеней потенциальной опасности, организация рабочего места в лаборатории для микроскопического исследования мокроты на КУМ (простая бактериоскопия, люминесцентная микроскопия)",
                    "Наличие подготовленного персонала для исследования мокроты на КУМ",
                    "Наличие ответственного лица для работы в кабинете забора мокроты",
                    "Определение алгоритма (регламента либо стандартной операционной процедуры) по организации и выполнению забора мокроты на исследование для обследуемых, в том числе для маломобильных и нетранспортабельных граждан",
                    "Соблюдение кратности исследования (3 раза), 1 раз в год",
                    "Количество исследований мокроты в течение текущего года (КУМ)",
                    "Количество положительных результатов",
                    "Алгоритм действий при выявлении положительного результата",
                    "Соблюдение сроков хранения «стекол» с положительным мазком на КУМ"
                ],
                hasComment: true
            }
        ];

        // Глобальные переменные
        let answers = {};
        let autoSaveInterval;
        let lastSaveTime = null;
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Установка текущей даты
            const now = new Date();
            const timestampInput = document.getElementById('timestamp');
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            timestampInput.value = `${year}-${month}-${day}`;
            
            // Генерация секций
            generateSections();
            
            // Обновление прогресс-бара
            updateProgressBar();
            
            // Обработчики событий для кнопок
            document.getElementById('save-btn').addEventListener('click', saveToLocalStorage);
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('print-btn').addEventListener('click', printForm);
            
            // Загрузка сохраненных данных
            loadFromLocalStorage();
            
            // Запуск автосохранения (каждые 3 минуты)
            startAutoSave();
            
            // Автоматическое увеличение полей комментариев
            setupAutoResizeTextareas();
        });
        
        function printForm() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('collapsed');
                section.classList.add('expanded');
            });
            setTimeout(() => {
                window.print();
            }, 100);
        }
        
        function setupAutoResizeTextareas() {
            document.querySelectorAll('.comment').forEach(textarea => {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            });
        }
        
        function startAutoSave() {
            // Автосохранение каждые 3 минуты (180000 миллисекунд)
            autoSaveInterval = setInterval(() => {
                saveToLocalStorage(true);
            }, 3 * 60 * 1000);
        }
        
        function generateSections() {
            const container = document.getElementById('sections-container');
            
            sections.forEach((section, index) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section collapsed';
                sectionElement.dataset.sectionIndex = index;
                
                const header = document.createElement('div');
                header.className = 'section-header';
                header.dataset.sectionIndex = index;
                
                const title = document.createElement('h2');
                title.textContent = section.title;
                
                const status = document.createElement('div');
                status.className = 'section-status';
                status.textContent = '0/' + (section.questions.length + 1);
                
                header.appendChild(title);
                header.appendChild(status);
                
                const content = document.createElement('div');
                content.className = 'section-content';
                
                section.questions.forEach((question, qIndex) => {
                    const questionElement = createQuestionElement(index, qIndex, question);
                    content.appendChild(questionElement);
                });
                
                // Дополнительная информация
                const additionalInfoElement = createQuestionElement(
                    index, 
                    section.questions.length, 
                    "Дополнительная информация / Примечания"
                );
                content.appendChild(additionalInfoElement);
                
                sectionElement.appendChild(header);
                sectionElement.appendChild(content);
                
                header.addEventListener('click', function() {
                    const sectionIndex = this.dataset.sectionIndex;
                    const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
                    
                    if (section.classList.contains('collapsed')) {
                        document.querySelectorAll('.section').forEach(s => {
                            s.classList.remove('expanded');
                            s.classList.add('collapsed');
                        });
                        section.classList.remove('collapsed');
                        section.classList.add('expanded');
                        
                        setTimeout(() => {
                            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    } else {
                        section.classList.remove('expanded');
                        section.classList.add('collapsed');
                    }
                    
                    setTimeout(() => {
                        setupAutoResizeTextareas();
                    }, 100);
                });
                
                container.appendChild(sectionElement);
            });
        }
        
        function createQuestionElement(sectionIndex, questionIndex, questionText) {
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            questionElement.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            
            const questionTextElement = document.createElement('div');
            questionTextElement.className = 'question-text';
            questionTextElement.textContent = questionText;
            
            const checkButton = document.createElement('div');
            checkButton.className = 'check-button';
            checkButton.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            
            questionElement.appendChild(questionTextElement);
            questionElement.appendChild(checkButton);
            
            const comment = document.createElement('textarea');
            comment.className = 'comment';
            comment.dataset.questionId = `${sectionIndex}-${questionIndex}`;
            comment.placeholder = 'Комментарий / замечания...';
            
            questionElement.appendChild(comment);
            
            comment.addEventListener('input', function() {
                if (this.value.trim() !== '' && !checkButton.classList.contains('checked')) {
                    checkButton.classList.add('checked');
                    questionElement.classList.add('completed');
                    updateSectionStatus(sectionIndex);
                    updateProgressBar();
                }
                saveAnswer(sectionIndex, questionIndex, checkButton.classList.contains('checked') ? 'Проверено' : 'Не проверено', this.value);
                saveToLocalStorage(true);
            });
            
            checkButton.addEventListener('click', function() {
                const isChecked = this.classList.contains('checked');
                
                if (isChecked) {
                    this.classList.remove('checked');
                    questionElement.classList.remove('completed');
                } else {
                    this.classList.add('checked');
                    questionElement.classList.add('completed');
                }
                
                updateSectionStatus(sectionIndex);
                updateProgressBar();
                
                saveAnswer(sectionIndex, questionIndex, this.classList.contains('checked') ? 'Проверено' : 'Не проверено', comment.value);
                saveToLocalStorage(true);
            });
            
            return questionElement;
        }
        
        function saveAnswer(sectionIndex, questionIndex, answer, comment = null) {
            if (!answers[sectionIndex]) answers[sectionIndex] = {};
            if (!answers[sectionIndex][questionIndex]) answers[sectionIndex][questionIndex] = {};
            answers[sectionIndex][questionIndex].answer = answer;
            answers[sectionIndex][questionIndex].comment = comment;
        }
        
        function updateSectionStatus(sectionIndex) {
            const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
            const statusElement = section.querySelector('.section-status');
            const totalQuestions = sections[sectionIndex].questions.length + 1;
            const answeredQuestions = section.querySelectorAll('.check-button.checked').length;
            statusElement.textContent = `${answeredQuestions}/${totalQuestions}`;
        }
        
        function updateProgressBar() {
            const progressBar = document.getElementById('progress');
            let totalQuestions = 0;
            let answeredQuestions = 0;
            
            sections.forEach((section, index) => {
                totalQuestions += section.questions.length + 1;
                if (answers[index]) {
                    answeredQuestions += Object.keys(answers[index]).length;
                }
            });
            
            const progressPercentage = (answeredQuestions / totalQuestions) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        function saveToLocalStorage(silent = false) {
            document.querySelectorAll('.check-button').forEach(button => {
                const questionId = button.dataset.questionId;
                const [sectionIndex, questionIndex] = questionId.split('-').map(Number);
                const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
                const comment = questionElement ? questionElement.querySelector('textarea') : null;
                saveAnswer(sectionIndex, questionIndex, button.classList.contains('checked') ? 'Проверено' : 'Не проверено', comment ? comment.value : null);
            });
            
            const timestamp = document.getElementById('timestamp').value;
            const orgName = document.getElementById('org-name').value;
            const orgDepartment = document.getElementById('org-department').value;
            
            const data = {
                timestamp: timestamp,
                orgName: orgName,
                orgDepartment: orgDepartment,
                answers: answers,
                lastSaved: new Date().toLocaleString('ru-RU')
            };
            
            localStorage.setItem('tb_early_detection_checklist_v4', JSON.stringify(data));
            lastSaveTime = new Date();
            
            if (!silent) alert('Данные сохранены в браузере!');
            updateAutoSaveStatus();
        }
        
        function updateAutoSaveStatus() {
            const statusElement = document.getElementById('auto-save-status');
            if (lastSaveTime) {
                const timeString = lastSaveTime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                statusElement.textContent = `Автосохранение: ${timeString}`;
            } else {
                statusElement.textContent = 'Автосохранение включено';
            }
        }
        
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('tb_early_detection_checklist_v4');
            if (savedData) {
                const data = JSON.parse(savedData);
                answers = data.answers || {};
                
                Object.keys(answers).forEach(sectionIndex => {
                    Object.keys(answers[sectionIndex]).forEach(questionIndex => {
                        const answerData = answers[sectionIndex][questionIndex];
                        const questionElement = document.querySelector(`[data-question-id="${sectionIndex}-${questionIndex}"]`);
                        
                        if (questionElement) {
                            const checkButton = questionElement.querySelector('.check-button');
                            if (checkButton && answerData.answer === 'Проверено') {
                                checkButton.classList.add('checked');
                                questionElement.classList.add('completed');
                            }
                            
                            if (answerData.comment) {
                                const comment = questionElement.querySelector('textarea');
                                if (comment) comment.value = answerData.comment;
                            }
                        }
                    });
                    updateSectionStatus(parseInt(sectionIndex));
                });
                
                if (data.timestamp) document.getElementById('timestamp').value = data.timestamp;
                if (data.orgName) document.getElementById('org-name').value = data.orgName;
                if (data.orgDepartment) document.getElementById('org-department').value = data.orgDepartment;
                
                updateProgressBar();
                updateAutoSaveStatus();
                
                setTimeout(() => { setupAutoResizeTextareas(); }, 100);
            }
        }
        
        function clearForm() {
            if (confirm('Вы уверены, что хотите очистить всю форму? Все данные будут удалены.')) {
                answers = {};
                localStorage.removeItem('tb_early_detection_checklist_v4');
                
                document.querySelectorAll('.question').forEach(question => {
                    question.classList.remove('completed');
                    const checkButtons = question.querySelectorAll('.check-button');
                    checkButtons.forEach(button => button.classList.remove('checked'));
                    
                    const textareas = question.querySelectorAll('textarea');
                    textareas.forEach(textarea => {
                        textarea.value = '';
                        textarea.style.height = '60px';
                    });
                });
                
                document.querySelectorAll('.section-status').forEach(status => {
                    const sectionIndex = status.closest('.section').dataset.sectionIndex;
                    status.textContent = `0/${sections[sectionIndex].questions.length + 1}`;
                });
                
                document.getElementById('org-name').value = '';
                document.getElementById('org-department').value = '';
                
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                document.getElementById('timestamp').value = `${year}-${month}-${day}`;
                
                updateProgressBar();
                updateAutoSaveStatus();
                alert('Форма очищена!');
            }
        }
        
        function exportToExcel() {
            const timestamp = document.getElementById('timestamp').value;
            const date = new Date(timestamp).toLocaleDateString('ru-RU');
            const orgName = document.getElementById('org-name').value || 'Не указано';
            const orgDepartment = document.getElementById('org-department').value || 'Не указано';
            
            const wb = XLSX.utils.book_new();
            const excelData = [];
            
            excelData.push(["Карта контроля организации раннего выявления туберкулеза в учреждениях общей лечебной сети"]);
            excelData.push([`Медицинская организация: ${orgName}`]);
            excelData.push([`Подразделение / Участок: ${orgDepartment}`]);
            excelData.push([`Дата проверки: ${date}`]);
            excelData.push([]);
            excelData.push(["Раздел", "Вопрос", "Статус", "Комментарий"]);
            
            sections.forEach((section, sectionIndex) => {
                excelData.push([section.title, "", "", ""]);
                
                section.questions.forEach((question, questionIndex) => {
                    const answerData = answers[sectionIndex]?.[questionIndex];
                    const answer = answerData?.answer || 'Не проверено';
                    const comment = answerData?.comment || '';
                    excelData.push(["", question, answer, comment]);
                });
                
                const additionalInfoData = answers[sectionIndex]?.[section.questions.length];
                const additionalInfoAnswer = additionalInfoData?.answer || 'Не проверено';
                const additionalInfoComment = additionalInfoData?.comment || '';
                excelData.push(["", "Дополнительная информация / Примечания", additionalInfoAnswer, additionalInfoComment]);
                excelData.push([]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, "Чек-лист ОЛС");
            XLSX.writeFile(wb, `карта_контроля_ОЛС_${date.replace(/\./g, '-')}.xlsx`);
        }
    </script>
</body>
</html>
